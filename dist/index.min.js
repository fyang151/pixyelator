function convertToImageElement(e){switch(!0){case e instanceof HTMLImageElement:return e;case e instanceof Blob:return blobToImageElement(e);case"string"==typeof e&&e.startsWith("data:"):return dataURLToImageElement(e);case"string"==typeof e:return imageUrlToImageElement(e);case e instanceof ArrayBuffer:return arrayBufferToImageElement(e);default:throw new Error("Unsupported image type")}}function blobToImageElement(e){const t=URL.createObjectURL(e),n=document.createElement("img");return n.src=t,new Promise((e,r)=>{n.onload=()=>{URL.revokeObjectURL(t),e(n)},n.onerror=()=>{URL.revokeObjectURL(t),r(n)}})}function dataURLToImageElement(e){const t=new Image;return t.src=e,new Promise((e,n)=>{t.onload=()=>e(t),t.onerror=e=>n(e)})}function imageUrlToImageElement(e){const t=new Image;return t.crossOrigin="anonymous",t.src=e,new Promise((e,n)=>{t.onload=()=>e(t),t.onerror=()=>n(t)})}function arrayBufferToImageElement(e){return blobToImageElement(new Blob([e],{type:"image/png"}))}function canvasToBlob(e){return new Promise((t,n)=>{e.toBlob(e=>{e?t(e):n(new Error("Canvas to Blob conversion failed"))},"image/png")})}function canvasToDataURL(e){return e.toDataURL("image/png")}function canvasToArrayBuffer(e){return new Promise((t,n)=>{e.toBlob(e=>{e?t(e.arrayBuffer()):n(new Error("Canvas to Blob conversion failed"))})})}export class Pixyelator{constructor(e,t={}){this._imageElement=e,this._width=e.naturalWidth,this._height=e.naturalHeight,this._maxWorkers=t.maxWorkers||navigator.hardwareConcurrency||4,this._canvas=t.targetCanvas||document.createElement("canvas"),this._isDisposed=!1}static async fromImage(e,t={}){const n=await convertToImageElement(e);if(!n)throw new Error("Failed to load image");if(0===n.naturalWidth||0===n.naturalHeight)throw new Error("Invalid image dimensions");return new Pixyelator(n,t)}pixelate(e,t,n={}){if(this._isDisposed)throw new Error("Cannot operate on disposed Pixyelator instance");if(!Number.isInteger(e)||!Number.isInteger(t)||e<=0||t<=0)throw new Error("Pixel dimensions must be positive integers");if(e>this._width||t>this._height)throw new Error("Pixel dimensions cannot exceed image dimensions");const r=this._pixelateElementToCanvas(e,t,n);return Object.assign(r,{toBlob:async()=>(await r,this.toBlob()),toCanvas:async()=>(await r,this.toCanvas()),toDataURL:async()=>(await r,this.toDataURL()),toArrayBuffer:async()=>(await r,this.toArrayBuffer())})}async _pixelateElementToCanvas(e,t,n={}){const r=this._imageElement,o=this._width,a=this._height,s=this._maxWorkers,i=n.grayscale||!1;return new Promise(n=>{const c=this._canvas,l=c.getContext("2d");c.width=o,c.height=a;const m=e>t,h=o%e,u=a%t;let f=Array.from({length:e},()=>Math.floor(o/e));for(let t=0;t<h;t++)f[Math.floor(t*(e/h))]++;let g=Array.from({length:t},()=>Math.floor(a/t));for(let e=0;e<u;e++)g[Math.floor(e*(t/u))]++;const d=[],w=[];let p=0;const y=m?g:f,E=m?f:g;let v=0;y.forEach(e=>{w.push([e,v]),v+=e});const _=Math.min(w.length,s);for(let e=0;e<_;e++)b();function b(e=null){if(w.length>0){const[t,s]=w.shift();return function(e,t,n=null){const[s,c,l,h]=m?[0,t,o,e]:[t,0,e,a];return new Promise((t,u)=>{createImageBitmap(r,s,c,l,h).then(r=>{n||(n=new Worker(new URL("innerWorker.min.js",import.meta.url)),d.push(n)),n.postMessage([r,o,a,e,i,E,m]),n.onmessage=e=>{t(e.data),b(n)},n.onerror=e=>{u(e),b(n)}})})}(t,s,e).then(e=>{const[t,r]=m?[0,s]:[s,0];l.drawImage(e,t,r),p++,p===y.length&&(d.forEach(e=>e.terminate()),n())})}}})}toCanvas(){if(this._isDisposed)throw new Error("Cannot operate on disposed Pixyelator instance");return this._canvas}async toBlob(){if(this._isDisposed)throw new Error("Cannot operate on disposed Pixyelator instance");return canvasToBlob(this._canvas)}toDataURL(){if(this._isDisposed)throw new Error("Cannot operate on disposed Pixyelator instance");return canvasToDataURL(this._canvas)}async toArrayBuffer(){if(this._isDisposed)throw new Error("Cannot operate on disposed Pixyelator instance");return canvasToArrayBuffer(this._canvas)}dispose(){this._isDisposed||(this._imageElement=null,this._canvas=null,this._isDisposed=!0)}}