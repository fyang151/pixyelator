onmessage=t=>{const e=t=>{const e=t.length,a=e/4;let o=0,l=0,s=0,f=0,n=0;for(;o<e;)[l,s,f,n]=[l+t[o],s+t[o+1],f+t[o+2],n+t[o+3]],o+=4;return l=Math.floor(l/a),s=Math.floor(s/a),f=Math.floor(f/a),n=Math.floor(n/a),[l,s,f,n]},[a,o,l,s,f,n,r]=t.data,g=new OffscreenCanvas(o,l),c=g.getContext("2d",{willReadFrequently:!0});c.drawImage(a,0,0);let $=0;for(const t of n){const[a,o,l,n]=r?[$,0,t,s]:[0,$,s,t],g=c.getImageData(a,o,l,n),[i,d,h,m]=e(g.data);if(f){const t=.299*i+.587*d+.114*h;c.fillStyle=`rgba(${t}, ${t}, ${t}, ${m})`}else c.fillStyle=`rgba(${i}, ${d}, ${h}, ${m})`;c.fillRect(a,o,l,n),$+=t}const i=g.transferToImageBitmap();self.postMessage(i,[i])};